---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
patches:
- patch: |
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --no-cross-namespace-refs=true
  target:
    kind: Deployment
    name: (kustomize-controller|helm-controller|notification-controller|image-reflector-controller|image-automation-controller)
- patch: |
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --no-remote-bases=true
  target:
    kind: Deployment
    name: kustomize-controller
- patch: |
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --default-service-account=default
  target:
      kind: Deployment
    name: (kustomize-controller|helm-controller)
- patch: |
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: AZURE_CLIENT_ID
        value: 678-132
  target:
    apiVersion: apps/v1
    kind: Deployment
    name: source-controller
- patch: |
    - op: add
      path: /spec/serviceAccountName
      value: kustomize-controller
  target:
    kind: Kustomization
    name: flux-system
- patch: |
    - op: add
      path: /spec/template/spec/tolerations
      value:
      - effect: NoSchedule
        key: CriticalAddonsOnly
        value: "true"
    - op: add
      path: /spec/template/spec/nodeSelector
      value:
        kubernetes.io/os: linux
        juliusbaer.com/nodetype: system
  target:
    kind: Deployment
- patch: |
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: jb-ca-source
        secret:
          secretName: jb-ca-source
  target:
    kind: Deployment
    name: source-controller
- patch: |
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts/-
      value:
        mountPath: /etc/ssl/certs/jb-ca.crt
        name: jb-ca-source
        subPath: ca.crt
  target:
    kind: Deployment
    name: source-controller
resources:
- gotk-components.yaml
- gotk-sync.yaml
